library("meshr")
library(mygene)
library("fdrtool") 
library("MeSH.Mmu.eg.db")

setwd("D:\\importantbk\\working\\lab_working\\sequencing\\BC160712\\1.mRNA+circRNA\\2_gene_expression_analysis\\2_3_differential_gene")



mydata_all <- read.csv("mw_all.txt", sep = "\t", stringsAsFactor = F)
mydata_down <- read.csv("下调基因.txt", sep = "\t", stringsAsFactor = F)
mydata_up <- read.csv("上调基因.txt", sep = "\t", stringsAsFactor = F)

all_list <- unique(mydata_all$gene.name)
down_list <- unique(mydata_down$gene.name)
up_list <- unique(mydata_up$gene.name)


## use mygene package
haha <- queryMany(down_list, scopes="symbol", fields=c("id"), species="mouse", returnall = T)

## get the mygene result as a dataframe
result <- cbind(haha$response[,1],as.character(haha$response[,2]),haha$response[,3],haha$response[,4])
colnames(result) <- c("notfound","query","id","X_score")
result <- as.data.frame(result)
result$query <- as.character(result$query)


## use biomaRt
library(biomaRt)

## define biomart object
## 1,biomart have changed a lot in the past few months. first we need add host="www.ensembl.org here to indicate the host site.
## 2,listMarts(host = "www.ensembl.org") can tell us the name of the database, we choose the "ENSEMBL_MART_ENSEMBL" here.

mart <- useMart("ENSEMBL_MART_ENSEMBL", dataset = "mmusculus_gene_ensembl", host="www.ensembl.org")

down_tab <- getBM(attributes = c("entrezgene","external_gene_name"),filters = "external_gene_name", down_list, mart = mart)

## get the result from biomaRt and mygene together, some result in biomaRt but some in mygene, so we have to combine them
overall <- merge(result, down_tab, all = T, by.x = "query", by.y = "external_gene_name")

overall$notfound <- as.numeric(overall$notfound)

## some gene can not be found in both biomaRt and mygene so we get rid of them
overall[!is.na(overall$notfound) & is.na(overall$entrezgene) == T, ]
index_filter <- as.numeric(row.names(overall[!is.na(overall$notfound) & is.na(overall$entrezgene) == T, ]))
overall_filter <- overall[-eval(index_filter),]

##combine the results, all the genes have a gene id from biomaRt or mygene calculation
overall_filter$final <- overall_filter$id
overall_filter$notfound[is.na(overall_filter$notfound)]  = 0
overall_filter$final <- as.character(overall_filter$final)
overall_filter$entrezgene <- as.numeric(overall_filter$entrezgene)


for(i in 1:length(overall_filter$id)){
  if(overall_filter$notfound[i] == 1){
    overall_filter$final[i] = overall_filter$entrezgene[i]
  }
}

overall_next <- overall_filter[,c(1,6)]

## some genes have more than one id in the result, we have to find them
dup_genes <- names(table(overall_next$query)[table(overall_next$query) >= 2])
overall_next[overall_next$query %in% dup_genes, ]

## the duplication of genes and ids have tow cases, first just duplication, second gene-id and gene-ENSMUSGxxxxxxxx
## we should eliminate both kinds of duplication
## in the first case, it can be easily done by unique() function
overall_next_f1 <- unique(overall_next)

## this step is to testify if the case 1 duplication have been removed
dup_genes <- names(table(overall_next_f1$query)[table(overall_next_f1$query) >= 2])
temp_tab <- overall_next_f1[overall_next_f1$query %in% dup_genes, ]


## in the second case, we want to abandon the gene-ENSMUSGxxxxxxxx record and keep the gene-id record
temp_seq <- as.numeric(row.names(temp_tab[nchar(temp_tab$final) > 11,]))
##temp_seq
##[1]   1   3   5   9  11  13  15  17  19  22  27  30  32  35  37  38  41  43  45  47  52  54  69  70  91  95  98 100 102 108 110 111 114 115 156 163 170 178 196 197 200 201 203 208 209 212 214 215 221
##[50] 222 225 228 230 232 234 237 241 243 245 249 254 256 258 266 269 279 324 328 331 362 383 389 397 402 411 412 438 453 484 518 520 528 529 552

##pay attention here , the temp row index numbers can not be used to filter the dataset, because they are not the right row index number, they inherit the number from former bigger dataset and when put into our filtered dataset, it represent the totally differect records, so we choose the method as follows:
overall_next_f2 <- overall_next_f1[row.names(overall_next_f1) %in% setdiff(as.numeric(row.names(overall_next_f1)), temp_seq),]


##but here we still have the gene id with ENSMUSGxxxxxxxx, but it is much more clean than before.
##now we try to deal with this left ENSMUSGxxxxxxxx
##


##allgeneid <- read.csv(file = "DE_genelist_id_all.txt", sep = "\t", header = F, stringsAsFactor = F)$V1
##siggeneid <- read.csv(file = "DE_genelist_id_sig.txt", sep = "\t", header = F, stringsAsFactor = F)$V1






# like topGO, it need to construct a MeSHHyperGParams object to specify all the parameters when do enrichment.
meshParams <- new("MeSHHyperGParams", #
                  geneIds = siggeneid, #
                  universeGeneIds = allgeneid, #
                  annotation = "MeSH.Hsa.eg.db", #
                  category = "C", # like the classification of BP,MF,CC in GO
                  database = "gene2pubmed", #can be gendoo, gene2pubmed or RBBH
                  pvalueCutoff = 0.05, #
                  pAdjust = "none") ## pAdjust is set to none because this is really a very limited example,most of the times we can set it to BH, QV or FDR.
                  
                  
meshR <- meshHyperGTest(meshParams)             ## hypergeometry calculation of pvalue

meshR                                           ## to see what kind of object the mesh is, is it like a GO?
##MeSH enrichment analysis for category Diseases 
##Annotation package used:  MeSH.Hsa.eg.db 
##The correspondance is retrived from:  gendoo 
##Number of MeSH terms identified:  9 

head(summary(meshR))
##       MESHID       Pvalue OddsRatio ExpCount Count Size              MESHTERM GENEID SOURCEID
##15774 D009361 0.0002619206  3.942771 11.32673    21   33 Neoplasm Invasiveness   1576     <NA>
##15775 D009361 0.0002619206  3.942771 11.32673    21   33 Neoplasm Invasiveness   6279     <NA>
##15776 D009361 0.0002619206  3.942771 11.32673    21   33 Neoplasm Invasiveness   2778     <NA>
##15777 D009361 0.0002619206  3.942771 11.32673    21   33 Neoplasm Invasiveness    894     <NA>
##15778 D009361 0.0002619206  3.942771 11.32673    21   33 Neoplasm Invasiveness   2524     <NA>
##15779 D009361 0.0002619206  3.942771 11.32673    21   33 Neoplasm Invasiveness   7306     <NA>


result <- summary(meshR)[summary(meshR)$GENEID %in% siggeneid,]

write.table(result, file = "MESH_result.txt",quote = F, row.names = F, col.names = T, sep = "\t")

save.abst(result)




##################################
## dealing with the mesh result
##################################

setwd("D:\\importantbk\\learning\\meshr\\limma_test")

result_tab <- read.csv(file = "MESH_result.txt", sep = "\t", stringsAsFactor = F)


geneid <- result_tab$GENEID

library(biomaRt)

mart <- useMart("ENSEMBL_MART_ENSEMBL", dataset = "hsapiens_gene_ensembl", host="www.ensembl.org")

##genesymbol <- getBM(attributes=c('hgnc_symbol'),filters = 'entrezgene', values = geneid,mart = mart)
genesymbol <- geneid

for (i in 1:length(geneid)){
  genesymbol[i] <- getBM(attributes=c('hgnc_symbol'),filters = 'entrezgene', values = as.character(geneid[i]),mart = mart)$hgnc_symbol
}

## view the overall distribution of pubmed papaers
barplot(table(result_tab$MESHTERM))

## view the distributions of MeSH terms containing over 100 pubmed papaers 
over100 <- table(result_tab$MESHTERM)[table(result_tab$MESHTERM)>100]

barplot(over100, ylim = c(-600,1500),names.arg=F)

text(x = 1:length(over100), y = -200, labels = names(over100),cex =1, srt = 65)


## view the terms by the means of pvalue
test <- unique(result_tab[,c(1,2,3,4,5,6,7)])

test_20 <- head(test,20)

barplot(test_20$Pvalue,main="the most significant MeSH terms",xlab="P-value",horiz=TRUE,names=FALSE)

text(-0.00000000000000001,1:20,test_20$MESHTERM,cex=0.8,xpd=T,srt=0,pos=4)










